version: "3.8"

services:
  vertocoind:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vertocoin-node
    restart: always
    ports:
      - "9333:9333" # P2P port
      - "9332:9332" # RPC port
    volumes:
      - vertocoin_data:/home/vertocoin/.vertocoin
      # - ./vertocoin.conf:/home/vertocoin/.vertocoin/vertocoin.conf:ro
    networks:
      - vertocoin-network
    healthcheck:
      test:
        [
          "CMD",
          "vertocoin-cli",
          "-rpcuser=vertouser",
          "-rpcpassword=vertouser2025",
          "getblockchaininfo",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  # Tor proxy for enhanced privacy
  tor:
    image: goldy/tor-hidden-service:latest
    container_name: vertocoin-tor
    restart: always
    environment:
      # VertoCoin node hidden service
      - SERVICE1_TOR_SERVICE_HOSTS=80:vertocoin-core:9333
      - SERVICE1_TOR_SERVICE_VERSION=3
      # Optional: Set a custom private key (leave empty for auto-generation)
      # - SERVICE1_TOR_SERVICE_KEY=<your_private_key>
    volumes:
      - tor-data:/var/lib/tor
    networks:
      - vertocoin-network

  # Tor SOCKS proxy for outbound connections
  tor-proxy:
    image: peterdavehello/tor-socks-proxy:latest
    container_name: vertocoin-tor-proxy
    restart: always
    ports:
      - "127.0.0.1:9050:9050" # SOCKS proxy port (bind to localhost only)
    networks:
      - vertocoin-network
    environment:
      - TOR_OPTS=--SocksPort 0.0.0.0:9050
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9050"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  explorer:
    image: amirulmus/vertomax-explore:latest
    container_name: vertocoin-explorer
    restart: always
    ports:
      - "3002:3002"
    environment:
      - BTCEXP_HOST=0.0.0.0
      - BTCEXP_PORT=3002
      - BTCEXP_BITCOIND_HOST=vertocoind
      - BTCEXP_BITCOIND_PORT=9332
      - BTCEXP_BITCOIND_USER=vertouser
      - BTCEXP_BITCOIND_PASS=vertouser2025
      - BTCEXP_COIN=VTO
      - BTCEXP_DISPLAY_CURRENCY=vto
      - BTCEXP_LOCAL_CURRENCY=USD
      - BTCEXP_PRIVACY_MODE=false
      - BTCEXP_NO_INMEMORY_RPC_CACHE=true
    networks:
      - vertocoin-network
    depends_on:
      - vertocoind

  # Optional: Vertocoin CLI service for easy interaction
  vertocoin-cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vertocoin-cli
    restart: always
    profiles:
      - cli # Only start when explicitly requested
    depends_on:
      - vertocoind
    volumes:
      - vertocoin_data:/home/vertocoin/.vertocoin
    networks:
      - vertocoin-network
    entrypoint:
      [
        "vertocoin-cli",
        "-datadir=/home/vertocoin/.vertocoin",
        "-conf=/home/vertocoin/.vertocoin/vertocoin.conf",
      ]
    command: ["--help"] # Default to showing help

  # Optional: Explorer/monitoring service
  # You can add a blockchain explorer here in the future

volumes:
  vertocoin_data:
    driver: local

networks:
  vertocoin-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.50.0.0/16
